#!/bin/bash
#
# Script name: bootstrap
# Description: Install xfce4 with my preferred applications and configurations.
# Dependencies: jq, sed, stow
# GitHub: https://github.com/ifcodesdotnet/.dotfiles
# Contributors: Ismael Fernandez
# Sources:
#   https://google.github.io/styleguide/shellguide.html
#     Shell scripting coding guidelines
#
#   https://stackoverflow.com/questions/64786/error-handling-in-bash
#     Error handling in bash
#   
#   https://unix.stackexchange.com/questions/28791/prompt-for-sudo-password-and-programmatically-elevate-privilege-in-bash-script
#     Prompt user for sudo access in script
#
#   https://stackoverflow.com/questions/3522341/identify-user-in-a-bash-script-called-by-sudo
#     Figuring out who ran script when used by sudo

log_error_exit(){
    echo $1 && exit
}

update_apt_cache(){
    echo updating apt cache.

    sudo apt update -y

    if [ $? -ne 0 ]; then
        log_error_exit "failure updating apt cache."
    fi
}

upgrade_apt_packages(){
    echo upgrading apt packages.
    
    sudo apt upgrade -y

    if [ $? -ne 0 ]; then
        log_error_exit "failure upgrading apt packages."
    fi
}

install_apt_packages(){
    sudo apt install -y jq

    if [ $? -ne 0 ]; then
        log_error_exit "Error installing jq!"
    fi

    local readonly apt_packages="$(jq -r .\"apt-packages\"[] $json_config)"

    for package in $apt_packages; do
        sudo apt install -y "${package}"

        if [ $? -ne 0 ]; then
            log_error_exit "Error installing ${package}"
        fi
    done
}

stow(){
    local readonly packages="$(jq -r .\"test\"[].package $json_config)"

    #syncing configuration one stow package at a time 
    for package in ${packages[@]}; do

        local stow_locations="$(jq -r ".\"test\"[] | select(.package==\"$package\") | .directory, .files[]" $json_config)"

        #Before configuration can be applied pre existing / default files and directories must be deleted
        for location in ${stow_locations[@]}; do
            if [[ "$(eval echo $location)" != "$(eval echo /home/$(logname))" ]]; then
                eval sudo rm -rf "$location"
            fi
        done
        
        local directories="$(jq -r ".\"test\"[] | select(.package==\"$package\") .directory" $json_config)"

        #Finally apply configuration each for each package each directory at a time
        for directory in ${directories[@]}; do
            eval sudo mkdir -p "$directory"
            eval sudo stow -v -d /home/$(logname)/.dotfiles/configs -t "$directory" "$package"
        done
    done
}

# #config file has my username hardcoded in file, need this function to make script more dynamic
update_genmon_script_location(){
  user=$(logname)
  #https://stackoverflow.com/questions/30871868/sed-replace-first-occurence-in-place-with-big-files
  #https://linuxconfig.org/how-to-substitute-only-a-first-match-occurrence-using-sed-command
  sed -i '0,/i/s//'$user'/' ~/.dotfiles/configs/xfce4/panel/genmon-1.rc
}

install_vscode(){
  ~/.dotfiles/scripts/install-software/install-vscode
}

install_vscode_extensions(){
  ~/.dotfiles/scripts/install-software/install-vscode-extensions
}

install_vimix_theme(){
  ~/.dotfiles/scripts/install-themes/install-vimix-theme
}

install_vimix_icon(){
  ~/.dotfiles/scripts/install-icons/install-vimix-icon
}

restore_interfaces_file(){
  echo begin restoration of interfaces file
  head -8 /etc/network/interfaces > ~/interfaces
  sudo rm /etc/network/interfaces
  sudo mv ~/interfaces /etc/network/interfaces
}

restart_system(){
  echo system bootstrapping complete, restarting now . . .
  sleep 1
  sudo reboot
}

main(){
    if [ $EUID != 0 ]; then
        sudo "$0" "$@"
        exit $?
    fi

    #GLOBALS
    readonly json_config="/home/$(logname)/.dotfiles/scripts/bootstrap/bootstrap.json"

    #update_apt_cache
    #upgrade_apt_packages
    #install_apt_packages
    
    stow
    #update_genmon_script_location
    #install_vscode
    #install_vscode_extensions
    #install_vimix_theme
    #install_vimix_icon
    #restore_interfaces_file
    #restart_system
}

main

# #https://askubuntu.com/questions/425754/how-do-i-run-a-sudo-command-inside-a-script
# #https://www.baeldung.com/linux/store-command-in-variable